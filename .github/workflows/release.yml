name: Manual Release

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Version bump type"
        required: true
        default: patch
        type: choice
        options: [patch, minor, major]

permissions:
  contents: write

jobs:
  prepare_tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.setver.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_PAT }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: App/package-lock.json

      - name: Install
        working-directory: App
        run: npm ci

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Set version + create commit + tag
        id: setver
        shell: bash
        run: |
          set -euo pipefail
          BUMP="${{ github.event.inputs.bump }}"

          npm --prefix App version "$BUMP" --no-git-tag-version

          NEW_VER="$(node -p "require('./App/package.json').version")"
          TAG="v$NEW_VER"

          git add App/package.json App/package-lock.json || true
          git commit -m "chore(release): $TAG"
          git tag "$TAG"

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

          # sanity
          git show-ref --tags --verify "refs/tags/$TAG"

      - name: Push commit
        run: git push origin HEAD:main

      - name: Push tag
        run: git push origin "refs/tags/${{ steps.setver.outputs.tag }}"

      - name: Create draft GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          gh release create "${{ steps.setver.outputs.tag }}" \
            --title "${{ steps.setver.outputs.tag }}" \
            --generate-notes \
            --draft

  build_and_upload:
    needs: prepare_tag
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}

    defaults:
      run:
        working-directory: App

    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.prepare_tag.outputs.tag }}
          token: ${{ secrets.RELEASE_PAT }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: App/package-lock.json

      - name: Install
        run: npm ci

      - name: Build (no publish)
        run: npx electron-builder --publish never

      - name: Upload core updater assets
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ needs.prepare_tag.outputs.tag }}"
          REPO="${{ github.repository }}"

          shopt -s nullglob

          CORE=( dist/*.exe dist/*.AppImage dist/latest*.yml dist/*.blockmap )

          FILES=()
          for f in "${CORE[@]}"; do
            [[ -f "$f" ]] && FILES+=("$f")
          done

          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "No updater assets found in dist/"
            ls -la dist || true
            exit 1
          fi

          echo "Uploading updater assets:"
          printf ' - %s\n' "${FILES[@]}"

          gh release upload "$TAG" "${FILES[@]}" --repo "$REPO" --clobber

  publish_release:
    needs: [prepare_tag, build_and_upload]
    runs-on: ubuntu-latest
    steps:
      - name: Publish the draft release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_PAT }}
        run: |
          gh release edit "${{ needs.prepare_tag.outputs.tag }}" \
            --repo "${{ github.repository }}" \
            --draft=false
